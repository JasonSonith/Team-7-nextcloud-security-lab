services:
  db:
    image: mariadb:11.8.5  # Updated 2025-11-25: Patched version (was mariadb:11)
    restart: always
    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    environment:
      - MARIADB_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MYSQL_DATABASE}
      - MARIADB_USER=${MYSQL_USER}
      - MARIADB_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - db:/var/lib/mysql
    # HARDENING: Security options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all capabilities by default
    cap_add:
      - CHOWN      # MariaDB needs to change file ownership
      - SETUID     # MariaDB needs to switch users internally
      - SETGID     # MariaDB needs to switch groups internally
      - DAC_OVERRIDE  # MariaDB needs to override file permissions
    # HARDENING: Resource limits (prevent DoS)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 256M

  app:
    image: nextcloud:29-apache  # Updated 2025-11-25: Use floating tag to match data version 29.0.16
    restart: always
    ports:
      - "0.0.0.0:8080:80"
    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
      - APACHE_SERVER_NAME=localhost
    depends_on:
      - db
    volumes:
      - nc:/var/www/html
    # HARDENING: Security options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all capabilities by default
    cap_add:
      - CHOWN      # Nextcloud needs to manage file ownership
      - SETUID     # Apache needs to switch to www-data user
      - SETGID     # Apache needs to switch groups
      - DAC_OVERRIDE  # Nextcloud needs to override file permissions for uploads
      - NET_BIND_SERVICE  # Apache needs to bind to port 80
    # HARDENING: Resource limits (prevent DoS)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  proxy:
    image: nginx:mainline-alpine  # Updated 2025-11-25: Best available (6 CVEs, 0 CRITICAL/HIGH) - Alpine 3.22.2
    restart: always
    depends_on:
      - app
    ports:
      - "443:443"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    # HARDENING: Run as nginx user (101:101)
    user: "101:101"
    # HARDENING: Security options
    security_opt:
      - no-new-privileges:true  # Prevent privilege escalation
    cap_drop:
      - ALL  # Drop all capabilities by default
    cap_add:
      - NET_BIND_SERVICE  # Nginx needs to bind to port 443
      - CHOWN      # Nginx needs to change file ownership for cache/logs
      - SETUID     # Nginx needs to drop privileges
      - SETGID     # Nginx needs to drop group privileges
    # HARDENING: Read-only root filesystem (nginx only reads configs)
    read_only: true
    tmpfs:
      - /var/cache/nginx:uid=101,gid=101  # Nginx needs writable cache directory (owned by nginx user)
      - /var/run:uid=101,gid=101          # Nginx needs writable PID directory (owned by nginx user)
      - /tmp:uid=101,gid=101              # Nginx needs writable temp directory (owned by nginx user)
    # HARDENING: Resource limits (prevent DoS)
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 128M

volumes:
  db: {}
  nc: {}
