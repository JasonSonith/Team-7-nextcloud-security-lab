# =============================================================================
# Nextcloud Security Lab - Hardened Docker Compose Configuration
# =============================================================================
# Team: Team 7
# Project: Nextcloud Security Assessment (6-Week Lab)
# Last Updated: 2025-11-25
#
# SECURITY PATCHES APPLIED:
#   - CVE-2024-3094 (xz-utils backdoor) - Fixed via updated Debian base
#   - CVE-2023-3446 (OpenSSL) - Fixed via updated Debian base
#   - CVE-2022-37454 (zlib) - Fixed via updated Debian base
#   - CVE-2023-4911 (glibc) - Fixed via updated Debian base
#   - CVE-2024-2756 (PHP) - Fixed in PHP 8.2.29
#
# CIS DOCKER BENCHMARK COMPLIANCE:
#   - 4.1  User namespace support (proxy runs as nginx:101)
#   - 5.3  Linux kernel capabilities restricted (cap_drop: ALL)
#   - 5.10 Memory usage limited (deploy.resources.limits.memory)
#   - 5.11 CPU priority set (deploy.resources.limits.cpus)
#   - 5.12 Root filesystem read-only (proxy only)
#   - 5.25 Prevent additional privileges (no-new-privileges:true)
#
# HARDENING MEASURES:
#   1. Pinned image versions (no floating tags)
#   2. Dropped all Linux capabilities, added back only required ones
#   3. Enabled no-new-privileges to prevent privilege escalation
#   4. Set CPU and memory limits to prevent DoS attacks
#   5. Read-only filesystem on nginx proxy
#   6. Non-root user for nginx proxy (UID 101)
#   7. Secrets via environment variables (not hardcoded)
#
# =============================================================================

services:
  # ===========================================================================
  # DATABASE: MariaDB 11.8.5
  # ===========================================================================
  # Role: Stores Nextcloud user data, files metadata, and configuration
  # Security: Internal only (not exposed to host network)
  # ---------------------------------------------------------------------------
  db:
    image: mariadb:11.8.5
    # ^ PINNED VERSION: MariaDB 11.8.5 LTS (released 2024-11-14)
    # ^ Previous: mariadb:11 (floating tag - INSECURE)
    # ^ CVEs remaining: 27 (0 Critical, 4 High in gosu binary - low risk)

    restart: always

    command: --transaction-isolation=READ-COMMITTED --binlog-format=ROW
    # ^ Required by Nextcloud for proper transaction handling

    environment:
      - MARIADB_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MYSQL_DATABASE}
      - MARIADB_USER=${MYSQL_USER}
      - MARIADB_PASSWORD=${MYSQL_PASSWORD}
      # ^ Secrets loaded from .env file (never commit .env to git!)

    volumes:
      - db:/var/lib/mysql
      # ^ Named volume for persistent database storage

    # -------------------------------------------------------------------------
    # HARDENING: Privilege Escalation Prevention
    # -------------------------------------------------------------------------
    security_opt:
      - no-new-privileges:true
      # ^ CIS 5.25: Prevents processes from gaining additional privileges
      # ^ Even if attacker exploits a vulnerability, they can't become root

    # -------------------------------------------------------------------------
    # HARDENING: Linux Capabilities (Principle of Least Privilege)
    # -------------------------------------------------------------------------
    cap_drop:
      - ALL
      # ^ Drop all 14+ default capabilities
    cap_add:
      - CHOWN       # Required: Change ownership of database files
      - SETUID      # Required: Switch to mysql user on startup
      - SETGID      # Required: Switch to mysql group on startup
      - DAC_OVERRIDE # Required: Override file permission checks for data dir
      # ^ Only 4 capabilities granted (was 14+ by default)
      # ^ 70%+ reduction in attack surface

    # -------------------------------------------------------------------------
    # HARDENING: Resource Limits (DoS Prevention)
    # -------------------------------------------------------------------------
    deploy:
      resources:
        limits:
          cpus: '2'       # Max 2 CPU cores
          memory: 2G      # Max 2GB RAM
        reservations:
          cpus: '0.25'    # Guaranteed 0.25 CPU cores
          memory: 256M    # Guaranteed 256MB RAM
      # ^ CIS 5.10, 5.11: Prevents resource exhaustion attacks
      # ^ A malicious query can't consume all server resources

  # ===========================================================================
  # APPLICATION: Nextcloud 29-apache
  # ===========================================================================
  # Role: Main Nextcloud application (PHP + Apache)
  # Security: Exposed on port 8080 (HTTP), proxied via nginx on 443 (HTTPS)
  # ---------------------------------------------------------------------------
  app:
    image: nextcloud:29-apache
    # ^ Nextcloud 29.0.16.1 with PHP 8.2.29
    # ^ Includes patches for CVE-2024-2756 (PHP heap overflow)
    # ^ Note: Using floating tag to maintain compatibility with existing data

    restart: always

    ports:
      - "0.0.0.0:8080:80"
      # ^ Direct HTTP access (for testing/debugging)
      # ^ Production: Remove this and use only nginx proxy on 443

    environment:
      - MYSQL_HOST=db
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - NEXTCLOUD_ADMIN_USER=${NEXTCLOUD_ADMIN_USER}
      - NEXTCLOUD_ADMIN_PASSWORD=${NEXTCLOUD_ADMIN_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
      - APACHE_SERVER_NAME=localhost
      # ^ Secrets loaded from .env file

    depends_on:
      - db
      # ^ Ensures database is running before Nextcloud starts

    volumes:
      - nc:/var/www/html
      # ^ Named volume for Nextcloud files and configuration
      # ^ Note: Cannot use read_only: true because Nextcloud writes files

    # -------------------------------------------------------------------------
    # HARDENING: Privilege Escalation Prevention
    # -------------------------------------------------------------------------
    security_opt:
      - no-new-privileges:true
      # ^ CIS 5.25: Prevents privilege escalation even if app is compromised

    # -------------------------------------------------------------------------
    # HARDENING: Linux Capabilities (Principle of Least Privilege)
    # -------------------------------------------------------------------------
    cap_drop:
      - ALL
    cap_add:
      - CHOWN           # Required: Change ownership of uploaded files
      - SETUID          # Required: Apache switches to www-data user
      - SETGID          # Required: Apache switches to www-data group
      - DAC_OVERRIDE    # Required: Override permissions for file uploads
      - NET_BIND_SERVICE # Required: Apache binds to port 80
      # ^ Only 5 capabilities granted (was 14+ by default)

    # -------------------------------------------------------------------------
    # HARDENING: Resource Limits (DoS Prevention)
    # -------------------------------------------------------------------------
    deploy:
      resources:
        limits:
          cpus: '2'       # Max 2 CPU cores
          memory: 2G      # Max 2GB RAM (Nextcloud can be memory-hungry)
        reservations:
          cpus: '0.5'     # Guaranteed 0.5 CPU cores
          memory: 512M    # Guaranteed 512MB RAM

  # ===========================================================================
  # PROXY: nginx (TLS Termination)
  # ===========================================================================
  # Role: Reverse proxy with TLS termination (HTTPS on port 443)
  # Security: Most hardened container (stateless, read-only filesystem)
  # ---------------------------------------------------------------------------
  proxy:
    image: nginx:mainline-alpine
    # ^ nginx on Alpine Linux 3.22.2 (minimal attack surface)
    # ^ CVEs remaining: 6 (0 Critical, 0 High - all BusyBox related)
    # ^ Previous: nginx:alpine (floating tag - INSECURE)

    restart: always

    depends_on:
      - app

    ports:
      - "443:443"
      # ^ HTTPS only - production access point

    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - ./nginx/certs:/etc/nginx/certs:ro
      # ^ :ro = read-only mount (nginx only reads configs)

    # -------------------------------------------------------------------------
    # HARDENING: Non-Root User
    # -------------------------------------------------------------------------
    user: "101:101"
    # ^ CIS 4.1: Run as nginx user (UID 101) instead of root
    # ^ Even if nginx is compromised, attacker doesn't get root access

    # -------------------------------------------------------------------------
    # HARDENING: Privilege Escalation Prevention
    # -------------------------------------------------------------------------
    security_opt:
      - no-new-privileges:true

    # -------------------------------------------------------------------------
    # HARDENING: Linux Capabilities (Principle of Least Privilege)
    # -------------------------------------------------------------------------
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Required: Bind to port 443
      - CHOWN            # Required: Manage cache file ownership
      - SETUID           # Required: Drop privileges after binding port
      - SETGID           # Required: Drop group privileges
      # ^ Only 4 capabilities granted

    # -------------------------------------------------------------------------
    # HARDENING: Read-Only Root Filesystem
    # -------------------------------------------------------------------------
    read_only: true
    # ^ CIS 5.12: Prevents attackers from modifying system files
    # ^ If nginx is compromised, attacker cannot plant backdoors

    tmpfs:
      - /var/cache/nginx:uid=101,gid=101
      - /var/run:uid=101,gid=101
      - /tmp:uid=101,gid=101
      # ^ Writable tmpfs for runtime data (owned by nginx user)
      # ^ Data is stored in RAM and cleared on restart

    # -------------------------------------------------------------------------
    # HARDENING: Resource Limits (DoS Prevention)
    # -------------------------------------------------------------------------
    deploy:
      resources:
        limits:
          cpus: '1'       # Max 1 CPU core (proxy is lightweight)
          memory: 512M    # Max 512MB RAM
        reservations:
          cpus: '0.25'    # Guaranteed 0.25 CPU cores
          memory: 128M    # Guaranteed 128MB RAM

# =============================================================================
# VOLUMES: Persistent Storage
# =============================================================================
volumes:
  db: {}
    # ^ MariaDB data (persists across container restarts)
  nc: {}
    # ^ Nextcloud files and configuration (persists across container restarts)

# =============================================================================
# PRODUCTION DEPLOYMENT NOTES
# =============================================================================
#
# Before deploying to production:
#
# 1. SECRETS MANAGEMENT
#    - Never commit .env file to version control
#    - Use Docker secrets or external secrets manager (Vault, AWS KMS)
#    - Rotate passwords regularly
#
# 2. TLS CERTIFICATES
#    - Replace self-signed certs with valid CA-signed certificates
#    - Use Let's Encrypt for free automated certificates
#    - Enable HSTS and OCSP stapling in nginx config
#
# 3. NETWORK ISOLATION
#    - Remove port 8080 exposure (HTTP direct access)
#    - Create dedicated Docker network for inter-container communication
#    - Use firewall rules to restrict external access
#
# 4. BACKUP STRATEGY
#    - Configure automated backups for db and nc volumes
#    - Test restore procedures regularly
#    - Store backups off-site
#
# 5. MONITORING
#    - Add health checks for all services
#    - Implement log aggregation (ELK, Loki)
#    - Set up alerting for security events
#
# 6. UPDATES
#    - Schedule monthly vulnerability scans (Trivy)
#    - Subscribe to Nextcloud security advisories
#    - Plan maintenance windows for patching
#
# =============================================================================
